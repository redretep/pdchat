<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDChat</title>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    h1 { margin: 0; }
    input, button, textarea {
      background: #1e1e1e;
      color: white;
      border: none;
      padding: 0.5rem;
      margin: 0.25rem;
      font-size: 1rem;
    }
    textarea {
      width: 100%;
      max-width: 600px;
      height: 300px;
      resize: none;
    }
    #chat-area {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    #roomLabel {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>PidiChat</h1>
  <div id="setup">
    <input id="nickname" placeholder="Enter your nickname" />
    <input id="roomInput" placeholder="Enter room name" />
    <button onclick="connect()">Connect</button>
  </div>

  <div id="chat-area">
    <div id="roomLabel"></div>
    <textarea id="chatLog" readonly></textarea>
    <input id="message" placeholder="Type message and press Enter" onkeydown="if(event.key==='Enter') send()" />
  </div>

  <!-- Load Yjs and y-webrtc from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/yjs@13.6.9/dist/yjs.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.3.6/dist/y-webrtc.js"></script>

  <script>
    let yArray, doc, nickname, room
    const chatLog = document.getElementById('chatLog')

    function renderChat() {
      const messages = yArray.toArray()
      chatLog.value = messages.join('\n')
      chatLog.scrollTop = chatLog.scrollHeight
      // Save locally
      localStorage.setItem(`pidichat-history-${room}`, JSON.stringify(messages))
    }

    function send() {
      const input = document.getElementById('message')
      const msg = input.value.trim()
      if (msg && yArray) {
        const time = new Date().toLocaleTimeString()
        yArray.push([`[${time}] ${nickname}: ${msg}`])
        input.value = ''
      }
    }

    function connect() {
      nickname = document.getElementById('nickname').value.trim()
      room = document.getElementById('roomInput').value.trim()
      if (!nickname || !room) return alert("Please enter both nickname and room.")

      document.getElementById('roomLabel').textContent = `Room: ${room}`
      document.getElementById('setup').style.display = 'none'
      document.getElementById('chat-area').style.display = 'flex'

      doc = new Y.Doc()
      const provider = new WebrtcProvider(room, doc)

      yArray = doc.getArray('messages')
      yArray.observe(() => {
        renderChat()
      })

      // Load local history
      const stored = localStorage.getItem(`pidichat-history-${room}`)
      if (stored) {
        try {
          const messages = JSON.parse(stored)
          messages.forEach(m => yArray.push([m]))
        } catch {}
      }

      renderChat()
    }
  </script>
</body>
</html>
